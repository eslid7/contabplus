<% include partials/header %>
	<!-- BEGIN PAGE -->
	<div class="page-content">

			<!-- BEGIN PAGE CONTAINER-->
			<div class="container-fluid">
				<!-- BEGIN PAGE HEADER-->
				<div class="row-fluid">
					<div class="span12">
						<h3>Empresa</h3>
					</div>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                        <!-- BEGIN EXAMPLE TABLE PORTLET-->
                        <div class="portlet box light-grey">
                            <div class="portlet-title">								
                            </div>
                            <div class="portlet-body">
                                <div class="table-toolbar">
                                    <div class="btn-group">
                                        <button id="newBusiness" class="btn green" onclick="cleanForm();$('#modalBusiness').modal('show')">
                                        Empresa <i class="icon-plus"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group pull-right">
                                    </div>
                                </div>
                                <table id="listBusiness" class="bt-table table-striped"
                                    data-side-pagination="server"
                                    data-pagination="true"
                                    data-page-size="20"
                                    data-page-list="[20, 40, 60]"
                                    data-search="true">
                                </table>
                            </div>
                        </div>
                        <!-- END EXAMPLE TABLE PORTLET-->
                    </div>
                </div>
			</div>
            <!-- listado de mis empresas -->
            
			<!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
			<div id="modalBusiness" class="modal container hide fade">
				<div class="modal-header">
					<button data-dismiss="modal" class="close" type="button">X</button>
					<h3 id='titleCatalog'>Empresas</h3>
				</div>
				<div class="modal-body">
					<form id="businessCatalog" action="#" >
						<input type="hidden" name="busId" id="busId" >
						<div class="row-fluid">							
							<div class="control-group span4 ">
								<label for="idType">
									Tipo de Identificación
								</label>
								<div class="controls">
									<select name="idType" id="idType" class="m-wrap span12">
										<option value="1">Jurídica</option>
										<option value="2">Física</option>
									</select>	
								</div>
							</div>
							<div class="control-group span4 ">
								<label for="accCode">
									Cedula Jurídica
								</label>
								<div class="controls">
									<input type="text" name="busJuriricalId" id="busJuriricalId" class="m-wrap span12" placeholder="Cedula Jurídica" maxlength="100">
								</div>
							</div>													
							<div class="control-group span4 ">
								<label for="accCode">
									Razon social
								</label>
								<div class="controls">
									<input type="text" name="busName" id="busName" class="m-wrap span12" placeholder="Nombre" maxlength="100">
								</div>
							</div>	
						</div>
						<div class="row-fluid">
							<div class="control-group span4 ">
								<label for="accCode">
									Nombre Comercial
								</label>
								<div class="controls">
									<input type="text" name="busNameFantasy" id="busNameFantasy" class="m-wrap span12" placeholder="Nombre Comercial" maxlength="100">
								</div>
							</div>							
							<div class="control-group span4">
								<label for="accName">
									Correo
								</label>
								<div class="controls">
									<input type="text" name="busEmail" id="busEmail" class="m-wrap span12" placeholder="Email" maxlength="60">
								</div>
							</div>
							<div class="control-group span4 ">
								<label for="accIsGlobal">
									Teléfono
								</label>
								<div class="controls">                                    
                                    <input type="text" name="busPhone" id="busPhone" class="m-wrap span12" placeholder="Teléfono" maxlength="25">
								</div>
							</div>
						</div>
						<div class="row-fluid">
							<div class="control-group span4 ">
								<label for="accCode">
									Numero de identificación Tributaria
								</label>
								<div class="controls">
									<input type="text" name="taxID" id="taxID" class="m-wrap span12" placeholder="Numero de identificación Tributaria" maxlength="100">
								</div>
							</div>
							<div class="control-group span4 ">
								<label for="accName">
									Apartado postal
								</label>
								<div class="controls">                                    
									<input type="text" name="postalMail" id="postalMail" class="m-wrap span12" placeholder="Apartado postal" Apartado postal="60">
								</div>
							</div>
							<div class="control-group span4 ">
								<label for="accName">
									País
								</label>
								<div class="controls">                                    
									<input type="text" name="contry" id="contry" class="m-wrap span12" placeholder="País" maxlength="60">
								</div>
							</div>
						</div>
						<div class="row-fluid">
							<div class="control-group span4 ">
								<label for="accName">
									Provincia
								</label>
								<div class="controls">                                    
									<input type="text" name="province" id="province" class="m-wrap span12" placeholder="Provincia" maxlength="60">
								</div>
							</div>								
							<div class="control-group span4 ">
								<label for="accName">
									Cantón
								</label>
								<div class="controls">                                    
									<input type="text" name="canton" id="canton" class="m-wrap span12" placeholder="Cantón" maxlength="60">
								</div>
							</div>
							<div class="control-group span4 ">
								<label for="accName">
									Distrito
								</label>
								<div class="controls">                                    
									<input type="text" name="district" id="district" class="m-wrap span12" placeholder="Distrito" maxlength="60">
								</div>
							</div>			
						</div>
						<div class="row-fluid">
							<div class="control-group span4 ">
								<label for="accName">
									Dirección
								</label>
								<div class="controls">                                    
									<input type="text" name="address" id="address" class="m-wrap span12" placeholder="Dirección" maxlength="120">
								</div>
							</div>
							<div class="control-group span4 ">
								<label for="accName">
									Sitio Web
								</label>
								<div class="controls">                                    
									<input type="text" name="webSite" id="webSite" class="m-wrap span12" placeholder="Sitio Web" maxlength="60">
								</div>
							</div>										
							<div class="control-group span4 ">		
								<label for="accCode">
									Moneda
								</label>
								<div class="controls" >  
									<select id="busMoney" name="busMoney" class="span10">
										<% for(var j = 0; j < moneyTypes.length; j++) { %>   
											<option value="<%=moneyTypes[j].monId%>"> <%=moneyTypes[j].monName%></option>
										<% }%>
									</select>                                               
								</div>					
							</div>	
						</div>			
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn dark btn-outline" data-dismiss="modal">Cerrar</button>
					<button type="button" class="btn green" onclick="fnBusiness()">Guardar</button>
				</div>
			</div>
	</div>
<% include partials/footer %>
<script type="text/javascript">
	$(document).ready(function(){
		$('#busMoney').select2({});
		$('#idType').select2({});
		$("#busPhone").inputmask("mask", {"mask": "9999999999999999999999999",'removeMaskOnSubmit': true,'autoUnmask': true, "clearIncomplete": false});
		handleTableData();
	});
	isFirtsDatatable = true;
	function handleTableData () {
		$('#listBusiness').bootstrapTable({
			height: getHeight(),
			method: 'GET',
			url: '/contab/business',
			cache: false,
			columns: [			
				{
					field: 'busJuriricalId',
					title: 'N° Identificación',
					sortable: true,
					width: '10%'
				},
				 {
				 	field: 'busName',
				 	title: 'Nombre',
				 	sortable: true,
				 	width: '20%'
				 }
				, 
				{
					field: 'address',
					title: 'Dirección',
					sortable: true,
					width: '10%'
				},{
					field: 'busStatus',
					title: 'Editar',
					sortable: false,
					width: '10%',
					formatter: operateFormatterEdit
				}
			]
		});
	};
	function getHeight() {
		return $(window).height();
	}
	function operateFormatterEdit(value, row, index) {
        return [
            "<button type='button' class='btn green' ",
            " onclick='seeData("+row.busId+", "+index+")'>",
            "<i class='icon-pencil'></i> Editar ",
            "</button>"
        ].join('');
	}
	function seeData(busId, index){
		console.log($('#listBusiness').bootstrapTable('getData')[index])
		$('#busId').val(busId)
		$('#busJuriricalId').val($('#listBusiness').bootstrapTable('getData')[index].busJuriricalId)
		$('#busName').val($('#listBusiness').bootstrapTable('getData')[index].busName)
		$('#busNameFantasy').val($('#listBusiness').bootstrapTable('getData')[index].busNameFantasy)
		$('#busEmail').val($('#listBusiness').bootstrapTable('getData')[index].busEmail)
		$('#busPhone').val($('#listBusiness').bootstrapTable('getData')[index].busPhone)
		$('#busMoney').val($('#listBusiness').bootstrapTable('getData')[index].busMoney).trigger('change');
		$('#idType').val($('#listBusiness').bootstrapTable('getData')[index].idType).trigger('change');
		$('#contry').val($('#listBusiness').bootstrapTable('getData')[index].contry)
		$('#province').val($('#listBusiness').bootstrapTable('getData')[index].province)
		$('#canton').val($('#listBusiness').bootstrapTable('getData')[index].canton)
		$('#district').val($('#listBusiness').bootstrapTable('getData')[index].district)
		$('#address').val($('#listBusiness').bootstrapTable('getData')[index].address)
		$('#webSite').val($('#listBusiness').bootstrapTable('getData')[index].webSite)
		$('#postalMail').val($('#listBusiness').bootstrapTable('getData')[index].postalMail)
		$('#taxID').val($('#listBusiness').bootstrapTable('getData')[index].taxID)
		$('#modalBusiness').modal('show')
	}
	function operateFormatterState(value, row, index) {
        return [
            "<button type='button' class='btn ",
            ((row.busStatus == 1) ? "green" : "red"),
            " btnActiveInactive'>",
            "<i class='icon-off'></i> ",
            ((row.busStatus == 1) ? "Activo" : "Inactivo"),
            "</button>"
        ].join('');
    }
	//make catalog
	$('#businessCatalog').validate({
		errorElement: 'label', //default input error message container
		errorClass: 'help-inline', // default input error message class
		ignore: "",
		rules: {
			busName: { required: true },
            busEmail: {required: true, email: true },
			busPhone : {required: true},
			busJuriricalId: {required: true},
			busNameFantasy: {required: true},
			contry: {required: true},
			province: {required: true},
			district: {required: true},
			address: {required: true}
		},
		messages: { // custom messages
			busName: { required: "El campo es requerido." },
            busEmail: { required: "El campo es requerido." , email: "Digite un correo electr&oacute;nico valido"},
			busPhone: { required: "El campo es requerido." },
			busJuriricalId: {required: "El campo es requerido." },
			busNameFantasy: {required: "El campo es requerido." },
			contry: {required: "El campo es requerido." },
			province: {required: "El campo es requerido." },
			address: {required: "El campo es requerido." }
		},
		highlight: function (element) { // hightlight error inputs
			$(element).closest('.control-group').addClass('error'); // set error class to the control group
		},
		success: function (label) {
			label.closest('.control-group').removeClass('error');
			label.remove();
		},
		errorPlacement: function (error, element) {
			if (element.closest('.icon-search').size() === 1) {
				error.addClass('help-small no-left-padding').insertAfter(element.closest('.icon-search'));
			} else if (element.next().attr("class")){
				error.addClass('help-small no-left-padding').insertAfter(element.next());
			} else {
				error.addClass('help-small no-left-padding').insertAfter(element);
			}
		},
		submitHandler: function (form) {
			form.submit();
		}
	});
    function refreshTable() {
        $('.bt-table').bootstrapTable('refresh', {silent: true});
    }
	function fnBusiness(){
		if($('#businessCatalog').valid()){
			$.ajax({
				type: "POST",
				url: "/contab/saveBusiness",
				data: $('#businessCatalog').serialize(), //se envia el form serializado
				beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
					showIsLoading("Procesando...");
				}
			}).done(function (data) {
				$('#modalBusiness').modal('hide');
				fnOpenSusessDialog(data.message)
				hideIsLoading();
				cleanForm();	
				refreshTable(); 						
			}).fail(function (data) {
				fnOpenErrorDialog(data.responseJSON.message);
				hideIsLoading();
				$('#modalBusiness').modal('hide');
			})
		}	
	}
	function cleanForm(){
		$('#busName').val('');
		$('#busPhone').val('');
		$('#busEmail').val('');	
		$('#busJuriricalId').val('');
		$('#busNameFantasy').val('');
		$('#taxID').val('');
		$('#province').val('');
		$('#canton').val('');	
		$('#district').val('');
		$('#address').val('');
		$('#webSite').val('');
		$('#contry').val('');
		$('#postalMail').val('');
		$('#busId').val('');
	}
</script>